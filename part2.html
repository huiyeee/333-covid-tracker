<html>
<!DOCTYPE html>
<meta charset="utf-8">
<style>
  path:hover {
	fill-opacity: .7;
  }
  .slider text {
    font-size: 0px;
  }
  .states {
    fill: #ccc;
    stroke: #fff;
  }

  .symbol {
    fill-opacity: .8;
    stroke: #fff;
  }
  div.tooltip-donut {
     position: absolute;
     text-align: center;
     padding: .5rem;
     background: #FFFFFF;
     color: #313639;
     border: 1px solid #313639;
     border-radius: 8px;
     pointer-events: none;
     font-size: 1.3rem;
  }
  #block_container {
    display: flex;
    justify-content: center;
  } 
</style>

<body>
  <svg></svg>
  <div id = "block_container">
    <div class="col-sm-2"><p id="value-time"></p></div>
    <div class="col-sm"><div id="slider-time"></div></div>
  </div>
  <div id = "block_container">
    Type: <select id="typeSelection" class="dropdown"></select><br>
  </div>

  <!-- d3 v7 integration -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <!-- d3 topojson -->
  <script src="http://d3js.org/topojson.v2.min.js"></script>
  <script src="./d3-simple-slider.js"></script>
  <script>
    let width = 960,
     height = 500;

    let projection = d3.geoAlbersUsa();
    let path = d3.geoPath()
      .projection(projection);

    let svg = d3.selectAll("svg")
      .attr("width", width)
      .attr("height", height);
    let variableOptions = ["cases", "deaths"];
    let dateVar;
    let typeVar = variableOptions[0];
    

    // DropDown menu
    d3.select("#typeSelection")
      .selectAll('myOptions')
     	.data(variableOptions)
      .enter()
    	.append('option')
      .text(function (d) {return d; }) // text showed in the menu
      .attr("value", function (d) { return d; })

    // Declare scale vars
    var colorScale, colorScaleDeath;
    var covid;
    var date = [];
    var dateDict = {};
    var stateDict = {};
    var popDict = {};
    var caseDict = {};
    var deathDict = {};

    // call the function that draws
    ready();

    let us, states, centroid;
    
    function getKeyByValue(object, value) {
      return Object.keys(object).find(key => object[key] === value);
    }

    function drawSlide() {
      var sliderTime = d3
      .sliderBottom()
      .min(0)
      .max(date.length-1)
      .step(1)
      .width(450)
      .ticks(0)
      .default(1)
      .on('onchange', val => {
        d3.select('p#value-time').text(((covid[sliderTime.value()].date)));
        dateVar = val;
        drawStates();
      });
      var gTime = d3
        .select('div#slider-time')
        .append('svg')
        .attr('width', 500)
        .attr('height', 100)
        .append('g')
        .attr('transform', 'translate(30,30)');

      gTime.call(sliderTime);
      d3.select('p#value-time').text((covid[sliderTime.value()].date));
    }

    function drawStates() {
      var div = d3.select("body").append("div")
                  .attr("class", "tooltip-donut")
                  .style("opacity", 0);   
      svg.selectAll("path")
        .attr("class", "states")
        .data(topojson.feature(states, states.objects.usStates).features)
        .join(
          enter => enter
          .append("path")
          .attr("d", path)
          .style("stroke", "#fff")
          .style("stroke-width", "1")
          .style("fill", "rgb(212, 212, 212)")
          .on('mouseover', function (event,d) {
              var stateAbbr = d.properties.STATE_ABBR
              var stateName = getKeyByValue(stateDict,stateAbbr)
              // console.log(stateAbbr)
              // console.log(getKeyByValue(stateDict,stateAbbr))
              d3.select(this).transition()
                  .duration('50')
                  .attr('opacity', '.85');
              div.transition()
                  .duration(50)
                  .style("opacity", 1);
              var display;
              if(typeVar == "cases"){
                display = stateName + "<br>" 
                          + "Total cases: " + caseDict[stateName] + "<br>" 
                          + "Infected Rate: " + (100*caseDict[stateName]/popDict[stateName]).toFixed(2) + "%";
              }
              else{
                display = stateName + "<br>" 
                          + "Total deaths: " + deathDict[stateName] + "<br>" 
                          + "Death Rate: " + (100*deathDict[stateName]/popDict[stateName]).toFixed(2) + "%";
              }
              div.html(display)
                  .style("left", (event.pageX + 10) + "px")
                  .style("top", (event.pageY - 15) + "px");
            })
            .on('mouseout', function (d, i) {
              d3.select(this).transition()
                  .duration('50')
                  .attr('opacity', '1');
              div.transition()
                  .duration('50')
                  .style("opacity", 0);
            })
          ,
          update => update
          .style("fill", function(d) {
            // Get data value
            var start = dateDict[covid[dateVar].date];
            var counter = start;
            while(covid[counter].date == covid[start].date){
              counter += 1;
              if(d.properties.STATE_ABBR == stateDict[covid[counter].state]){
                if(typeVar == "cases"){
                  caseDict[covid[counter].state] = covid[counter].cases;
                  return colorScale(covid[counter].cases/popDict[covid[counter].state]);
                }
                else{
                  deathDict[covid[counter].state] = covid[counter].deaths;
                  return colorScaleDeath(covid[counter].deaths/popDict[covid[counter].state]);
                }
              }
            }
          }),
        )
    }

    d3.select("#typeSelection").on("change", function(d) {
        typeVar = d3.select(this).property("value")
        drawStates();
    })

    async function ready() {
      // load files async; store the values so we can use them later
      states = await d3.json("states.json");
      centroid = await d3.json("states-centroid-data.json");
      covid = await d3.csv("us-states.csv");
      stateName = await d3.csv("stateName.csv")
      for (let i = 0; i < stateName.length; i++) {
        caseDict[stateName[i]["State"]] =  0
        deathDict[stateName[i]["State"]] =  0
        stateDict[stateName[i]["State"]] =  stateName[i]["Code"]
      }

      // Get all scales
      colorScale = d3.scaleLinear()
          .domain([0,0.6])
          .range(["#d4d4d4","#ff0000"])
      colorScaleDeath = d3.scaleLinear()
          .domain([0,0.01])
          .range(["#d4d4d4","#ff0000"])
      for(var state in centroid.features){
        popDict[centroid.features[state].properties.name] = centroid.features[state].properties.population;
      }
      for (let i = 0; i < covid.length; i++) {
        if(!(covid[i].date in dateDict)){
          dateDict[covid[i].date] = i;
        }
        date.push(covid[i].date);
      }
      // console.log(stateDict)
      drawStates();
      drawSlide();
    }

  </script>

</body>
</html>